import rss from '@astrojs/rss';
import { getCollection } from 'astro:content';
import sanitizeHtml from 'sanitize-html';
import MarkdownIt from 'markdown-it';
import getSortedPosts from "@/utils/getSortedAny";
import { SITE } from "@/config";
const parser = new MarkdownIt();



export async function GET() {
  const blog = await getCollection("blog");
  const sortedBlogPosts = getSortedPosts(blog).sort(
    (a, b) =>
      new Date(b.data.pubDatetime).getTime() -
      new Date(a.data.pubDatetime).getTime()
  );

  return rss({
    stylesheet: '/rss/styles.xsl',
    title: 'tnorlin.se - all posts feed',
    description: SITE.desc,
    site: SITE.website,
    customData: `<atom:link href="${SITE.website}/rss.xml" rel="self" type="application/rss+xml" xmlns:atom="http://www.w3.org/2005/Atom"/>`,
    trailingSlash: false,
    items: sortedBlogPosts.map((post) => ({
      title: post.data.title,
      content: sanitizeHtml(parser.render(post.body), {
      }),
      pubDate: new Date(post.data.modDatetime ?? post.data.pubDatetime),
      description: post.data.description,
      // Compute RSS link from post `id`
      // This example assumes all posts are rendered as `/blog/[id]` routes
      link: `/blog/${post.id}/`,
    })),
  });
}
